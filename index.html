<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Foxhole Artillery Calculator</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.3/css/bootstrap.min.css" integrity="sha384-Zug+QiDoJOrZ5t4lssLdxGhVrurbmBWopoEl+M6BdEfwnCJZtKxi1KgxUyJq13dy" crossorigin="anonymous">
</head>
<body>
    <div class="container">
        <section>
            <h2>Target</h2>
            <div class="input-group mb-3">
                <div class="input-group-prepend">
                    <span class="input-group-text">Distance</span>
                </div>
                <input id="input_tar_dist" type="number" class="form-control" tabindex="1" autofocus placeholder="from spotter to target" aria-label="from spotter to target">
                <div class="input-group-append">
                    <span class="input-group-text">meters</span>
                </div>
            </div>
            <div class="input-group mb-3">
                <div class="input-group-prepend">
                    <span class="input-group-text">Azimuth</span>
                </div>
                <input id="input_tar_azim" type="number" class="form-control" tabindex="2" placeholder="from spotter to target" aria-label="from spotter to target">
                <div class="input-group-append">
                    <span class="input-group-text">degrees</span>
                    <button id="btn_swapcourse_tar_azim" class="btn btn-outline-secondary" title="swap backcourse">&#x21c4;</button>
                </div>
            </div>
        </section>

        <section>
            <hr/>
            <div id="container_additional_trps"><!-- TODO: New TRPs go here --></div>
            <button id="btn_add_trp" class="btn btn-secondary btn-sm">+ Add Target Reference Point</button>
            <button id="btn_del_trp" class="btn btn-outline-danger btn-sm">- remove Target Reference Point</button>
            <hr/>
        </section>

        <section>
            <h2>Artillery</h2>
            <div class="input-group mb-3">
                <div class="input-group-prepend">
                    <span class="input-group-text">Distance</span>
                </div>
                <input id="input_art_dist" type="number" class="form-control" tabindex="50">
                <div class="input-group-append">
                    <span class="input-group-text">meters</span>
                </div>
            </div>
            <div class="input-group mb-3">
                <div class="input-group-prepend">
                    <span class="input-group-text">Azimuth</span>
                </div>
                <input id="input_art_azim" type="number" class="form-control" tabindex="51">
                <div class="input-group-append">
                    <span class="input-group-text">degrees</span>
                    <button id="btn_swapcourse_art_azim" class="btn btn-outline-secondary" title="swap backcourse">&#x21c4;</button>
                </div>
            </div>
        </section>
        <section>
            <button id="btn_compute" type="button" class="btn btn-outline-primary" tabindex="60">Compute</button>
            <button id="btn_clear_tar" type="button" class="btn btn-outline-secondary">Clear Target</button>
            <button id="btn_clear" type="button" class="btn btn-outline-secondary">Clear All</button>
            <button id="btn_info" type="button" class="btn btn-outline-info">Info</button>
        </section>
        <section id="sec_info">
            <h2>Information</h2>
            <p>To use this calculator:</p>
            <ol>
                <li>Have a spotter determine the distance and azimuth to the target location.</li>
                <li>Without moving, have the spotter determine the distance and azimuth to the artillery location.</li>
                <li>Input the two sets of values, and the computed result is the distance and azimuth from the artillery to the target.</li>
                <li>Adjust the artillery settings to match the resulting values, then fire!</li>
                <li>You can optionally insert linked Target Reference Points between the spotter and the arty, this allows for spotting beyond binocular range.</li>
            </ol>
            <p>The <strong>In-game values</strong> in the result are rounded to match the in-game increments.</p>
            <p>Please report bugs and suggestions <a href="https://github.com/earthgrazer/foxhole-artillery-calc/issues" target="_blank">here</a>.</p>
        </section>
        <section id="sec_result">
            <h2>Result</h2>
            <div id="raw_result_div"></div>
            <div id="est_result_div"></div>
        </section>
    </div>
    <script
            src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
            integrity="sha256-k2WSCIexGzOj3Euiig+TlR8gA0EmPjuc79OEeY5L45g="
            crossorigin="anonymous"></script>
    <script type="text/javascript" src="./js/artycalc.js"></script>
    <script type="text/javascript">
        $(document).ready(function() {
            $("#sec_result").hide();

            $("#btn_compute").click(function() {
                // final leg spotter->tgt
                var tar_dist = parseFloat($("#input_tar_dist").val());
                var tar_azim = parseFloat($("#input_tar_azim").val());
                
                // leg spotter -> arty||trp1
                var art_dist = parseFloat($("#input_art_dist").val());
                var art_azim = parseFloat($("#input_art_azim").val());
                
                // Resolve optional TRPs in between and thus create a new big leg spotter->arty.
                // We walk the TRPs from the arty to the target and resolve each new TRP into a
                // iteratively growing final vector. All resolved intermediate vectors replace the last spotter->arty vector in the end.
                // For the first TRP (as seen from arty) we need the vector, however subsequent lookups need the previuos intermediate_vector
                // console.log("resolving "+trp_list.length+" TRPs");
                for (var i=trp_list.length-1; i >= 0; i--) {
                    // get this TRPs vector to the arty.
                    // (for the nearest TRP this is its stored azimut, all others in the chain need the resolved intermediate_vector value)
                    var trp_idx      = trp_list[i];
                    var trp_art_dist = (i==trp_list.length-1)? parseFloat($("#input_trp_"+trp_idx+"_dist").val()) : art_dist;
                    var trp_art_azim = (i==trp_list.length-1)? parseFloat($("#input_trp_"+trp_idx+"_azim").val()) : art_azim;
                    // console.log("resolve TRP #"+trp_idx+":  trp_art_azim="+trp_art_azim+"; trp_art_azim="+trp_art_azim);
                    
                    // get vector from this TRP to the next one (either another TRP or original spotter->arty)
                    var next_src     = (i>0)?  "#input_trp_"+trp_list[i-1] : "#input_art";
                    var next_dist    = parseFloat($(next_src+"_dist").val());
                    var next_azim_to = parseFloat($(next_src+"_azim").val());
                    var next_azim    = artycal.get_backcourse(next_azim_to); // the data points towards us, but we need it to point from us to them
                    // console.log("resolve TRP #"+trp_idx+":  next_dist="+next_dist+"; next_azim="+next_azim+" (backcourse from "+next_src+"_azim="+next_azim_to+")");
                    
                    // calculate dist+azim from arty to the next point
                    var intermediate_vector = artycal.calc_artillery(next_dist, next_azim, trp_art_dist, trp_art_azim);
                    if (intermediate_vector.hasOwnProperty("error")) {
                        $("#raw_result_div").html("Error in TRP #"+trp_idx+" input value(s)");
                        $("#est_result_div").html("");
                        $("#sec_result").show();
                        return;
                    } else {
                        // we now know the vector from the arty to the next spot.
                        // the backcourse of that is what we need for the next (or final) resolving iteration.
                        art_dist = intermediate_vector.art_tar_dist;
                        art_azim = artycal.get_backcourse(intermediate_vector.art_tar_deg);
                        // console.log("resolve TRP #"+trp_idx+":  new_art_dist="+art_dist+"; new_art_azim="+art_azim+" (intermediate_vector.art_tar_deg="+intermediate_vector.art_tar_deg+")");
                    }
                    
                    
                }

                // Calculate vector from arty->spotters target.
                // Either that is directly that from the spotter, or the resolved intermediate_vector from the TRP chain
                var result = artycal.calc_artillery(tar_dist, tar_azim, art_dist, art_azim);

                if (result.hasOwnProperty("error")) {
                    $("#raw_result_div").html("Error in input value(s)");
                    $("#est_result_div").html("");
                }
                else {
                    $("#raw_result_div").html("Raw values: [Distance: " + result.art_tar_dist + ", Azimuth: " + result.art_tar_deg + "]");
                    var roundedResultAzim = Math.round(result.art_tar_deg);
                    if (roundedResultAzim == 360) roundedResultAzim = 0;
                    $("#est_result_div").html("<strong>In-game values: [Distance: " + artycal.roundTo5(result.art_tar_dist) + "m, Azimuth: " + roundedResultAzim + "]</strong>");
                }

                $("#sec_result").show();
                $("#sec_info").hide();
            });
            
            $('#btn_swapcourse_tar_azim').click(function() {
                var backcourse = artycal.get_backcourse( parseFloat($("#input_tar_azim").val()) );
                $("#input_tar_azim").val( backcourse );
            });
            $('#btn_swapcourse_art_azim').click(function() {
                var backcourse = artycal.get_backcourse( parseFloat($("#input_art_azim").val()) );
                $("#input_art_azim").val( backcourse );
            });

            $("#btn_clear").click(function() {
                $("#input_tar_dist").val("").focus();
                $("#input_tar_azim").val("");
                $("#input_art_dist").val("");
                $("#input_art_azim").val("");
                for (var i=trp_list.length; i>0; i--) {
                    dropLastTRP();
                };
            });

            $("#btn_clear_tar").click(function() {
                $("#input_tar_dist").val("").focus();
                $("#input_tar_azim").val("");
            });

            $("#btn_info").click(function() {
                $("#sec_result").hide();
                $("#sec_info").show();
            });

            $("input").focus(function() {
                $(this).select();
            });
            
            
            
            /***********************
            * TRP functionality    *
            ************************/
            let trp_list = []; // list of trp indexes
            var update_trp_buttonstate = function() {
                var m = "from spotter to artillery";
                if (trp_list.length > 0) {
                    var lasTRPIdx = trp_list[trp_list.length-1];
                    $("#btn_del_trp").show();
                    m = "from TRP #"+lasTRPIdx+" to artillery";
                } else {
                    $("#btn_del_trp").hide();
                    var m = "from spotter to artillery";
                }
                $("#input_art_dist").attr("placeholder", m);
                $("#input_art_dist").attr("aria-label", m);
                $("#input_art_azim").attr("placeholder", m);
                $("#input_art_azim").attr("aria-label", m);
            };
            update_trp_buttonstate();
            
            var dropLastTRP = function() {
                var lastID =  trp_list.pop();
                $("#trp_"+lastID).remove();
                update_trp_buttonstate();
            }
            
            $('#btn_add_trp').click(function() {
                // Adds a new TRP to the selection
                var prevTRPid     = trp_list[trp_list.length - 1];
                var prevTRPid_txt = (prevTRPid)? "TRP #"+prevTRPid : "spotter";
                var newTRPid      = trp_list.length + 1;
                trp_list.push(newTRPid);
                
                // prepare simple HTML template
                var html_template = `<section id="trp_{newTRPid}">
                        <h2>Target Reference Point (TRP) #{newTRPid}</h2>
                        <div class="input-group mb-3">
                            <div class="input-group-prepend">
                                <span class="input-group-text">Distance</span>
                            </div>
                            <input id="input_trp_{newTRPid}_dist" type="number" placeholder="from {prevTRPid_txt} to TRP #{newTRPid}" class="form-control" aria-label="from {prevTRPid_txt} to TRP #{newTRPid}" tabindex="{tabindex_dist}">
                            <div class="input-group-append">
                                <span class="input-group-text">meters</span>
                            </div>
                        </div>
                        <div class="input-group mb-3">
                            <div class="input-group-prepend">
                                <span class="input-group-text">Azimuth</span>
                            </div>
                            <input id="input_trp_{newTRPid}_azim" type="number" placeholder="from {prevTRPid_txt} to TRP #{newTRPid}" class="form-control" aria-label="from {prevTRPid_txt} to TRP #{newTRPid}" tabindex="{tabindex_azim}">
                            <div class="input-group-append">
                                <span class="input-group-text">degrees</span>
                                <button id="btn_swapcourse_trp_{newTRPid}_azim" class="btn btn-outline-secondary" title="swap backcourse">&#x21c4;</button>
                            </div>
                        </div>
                    </section>
                `;
                // replace variables in the template and
                // finally add templated HTML container for the TRP
                html_template = html_template.replace(/{prevTRPid}/g,     prevTRPid);
                html_template = html_template.replace(/{prevTRPid_txt}/g, prevTRPid_txt);
                html_template = html_template.replace(/{newTRPid}/g,      newTRPid);
                html_template = html_template.replace(/{tabindex_dist}/g, newTRPid+10);
                html_template = html_template.replace(/{tabindex_azim}/g, newTRPid+11);
                $("#container_additional_trps").append(html_template);
                
                $("#btn_swapcourse_trp_"+newTRPid+"_azim").click(function() {
                    var backcourse = artycal.get_backcourse( parseFloat($("#input_trp_"+newTRPid+"_azim").val()) );
                    $("#input_trp_"+newTRPid+"_azim").val( backcourse );
                });
                
                update_trp_buttonstate();
            });
            
            
            $("#btn_del_trp").click(function() {
                dropLastTRP();
            });
            
        });
    </script>
</body>
</html>
